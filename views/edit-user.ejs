<%- contentFor('extra_css') %>

    <%- contentFor('content') %>

        <div class="container-xxl">
            <div class="row justify-content-center">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Edit User</h4>
                        </div>
                        <div class="card-body">
                            <!-- Display success/error messages if any -->
                            <% if (typeof message !=='undefined' && message) { %>
                                <div class="alert alert-<%= messageType || 'success' %>">
                                    <%= message %>
                                </div>
                                <% } %>

                                    <form action="/edit-user/<%= user._id %>" method="POST"
                                        enctype="multipart/form-data" id="editUserForm">
                                        <!-- Profile Image Section -->
                                        <div class="mb-4 text-center">
                                            <div class="position-relative d-inline-block">
                                                <img id="profileImgPreview"
                                                    src="/<%= user.profileImage || 'images/default-avatar.png' %>"
                                                    alt="Profile Image"
                                                    class="rounded-circle border border-3 border-light shadow"
                                                    style="width: 120px; height: 120px; object-fit: cover;"
                                                    onerror="this.src='/images/default-avatar.png'">
                                                <div class="position-absolute top-0 start-0 w-100 h-100 rounded-circle bg-dark bg-opacity-50 d-flex align-items-center justify-content-center"
                                                    style="opacity: 0; transition: opacity 0.3s; cursor: pointer;"
                                                    onclick="document.getElementById('profileImage').click()"
                                                    onmouseover="this.style.opacity='1'"
                                                    onmouseout="this.style.opacity='0'">
                                                    <i class="fas fa-camera text-white fs-4"></i>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <label for="profileImage" class="form-label text-muted">Change Profile
                                                    Picture</label>
                                                <input type="file" id="profileImage" name="profileImage"
                                                    accept="image/*" class="form-control d-none">
                                                <input type="hidden" name="existingImage"
                                                    value="<%= user.profileImage %>">
                                                <small class="text-muted d-block">Supported formats: JPG, PNG, GIF (Max:
                                                    5MB)</small>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="name" class="form-label">Full Name</label>
                                                    <input type="text" class="form-control" id="name" name="name"
                                                        value="<%= user.name %>" required placeholder="Enter full name">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="username" class="form-label">Username</label>
                                                    <input type="text" class="form-control" id="username"
                                                        name="username" value="<%= user.username %>" required
                                                        placeholder="Enter username">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="email" class="form-label">Email</label>
                                                    <input type="email" class="form-control" id="email" name="email"
                                                        value="<%= user.email %>" required
                                                        placeholder="Enter email address">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="role" class="form-label">Role</label>
                                                    <select class="form-select" id="role" name="role" required>
                                                        <option value="">Select a role</option>
                                                        <% for (let i=0; i < roles.length; i++) { %>
                                                            <option value="<%= roles[i]._id %>"
                                                                <%=user.role_id===roles[i]._id ? 'selected' : '' %>><%=
                                                                    roles[i].name %>
                                                            </option>
                                                            <% } %>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">Update User</button>
                                            <button type="button" class="btn btn-danger"
                                                onclick="confirmDelete()">Delete User</button>
                                            <a href="/users" class="btn btn-secondary">Cancel</a>
                                        </div>
                                    </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete <strong>
                                <%= user.name %>
                            </strong>?</p>
                        <p class="text-danger">This action cannot be undone and will permanently remove all user data.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="deleteUser()">Yes, Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <%- contentFor('extra_javascript') %>
            <script>
                // Image preview functionality
                document.getElementById('profileImage').addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file size (5MB limit)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('File size must be less than 5MB');
                            this.value = '';
                            return;
                        }

                        // Validate file type
                        if (!file.type.match('image.*')) {
                            alert('Please select a valid image file');
                            this.value = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function (evt) {
                            document.getElementById('profileImgPreview').src = evt.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Delete confirmation modal
                function confirmDelete() {
                    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    deleteModal.show();
                }

                function deleteUser() {
                    // Create a form to submit DELETE request
                    const deleteUserRequest = fetch('/api/deleteUser/<%= user._id %>', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    deleteUserRequest.then(response => {
                        if (response.ok) {
                            alert('User deleted successfully');
                            window.location.href = '/users';
                        } else {
                            alert('Failed to delete user. Please try again.');
                        }
                    });
                }

                // Form validation
                document.getElementById('editUserForm').addEventListener('submit', function (e) {
                    const name = document.getElementById('name').value.trim();
                    const username = document.getElementById('username').value.trim();
                    const email = document.getElementById('email').value.trim();
                    const role = document.getElementById('role').value;

                    if (!name || !username || !email || !role) {
                        e.preventDefault();
                        alert('Please fill in all required fields');
                        return false;
                    }

                    // Email validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        e.preventDefault();
                        alert('Please enter a valid email address');
                        return false;
                    }

                    // Username validation (alphanumeric and underscores only)
                    const usernameRegex = /^[a-zA-Z0-9_]+$/;
                    if (!usernameRegex.test(username)) {
                        e.preventDefault();
                        alert('Username can only contain letters, numbers, and underscores');
                        return false;
                    }
                });
            </script>