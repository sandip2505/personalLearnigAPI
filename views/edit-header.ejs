<%- contentFor('extra_css') %>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-add {
      background: #28a745;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      color: white;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .btn-add:hover {
      background: #218838;
    }

    .btn-remove {
      background: #dc3545;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      color: white;
      font-size: 12px;
      transition: background-color 0.3s;
    }

    .btn-remove:hover {
      background: #c82333;
    }

    .dynamic-section {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
    }

    .submenu-section {
      border: 1px solid #d0d0d0;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      background: #ffffff;
    }

    .logo-preview-container {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      background: #f8f9fa;
      transition: border-color 0.3s;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .logo-preview-container.dragover {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .logo-preview {
      max-width: 200px;
      max-height: 100px;
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logo-placeholder {
      color: #6c757d;
      font-size: 48px;
      margin-bottom: 10px;
    }

    .file-info {
      margin-top: 10px;
      font-size: 0.9em;
      color: #6c757d;
    }

    .remove-logo {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      font-size: 12px;
      cursor: pointer;
    }

    .logo-wrapper {
      position: relative;
      display: inline-block;
    }

    .upload-zone {
      cursor: pointer;
      width: 100%;
    }
  </style>

  <%- contentFor('content') %>
    <div class="container-fluid py-4">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="card shadow-lg border-0">
            <div class="card-header">
              <h4 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Header Configuration</h4>
            </div>
            <div class="card-body">
              <form action="/edit-header/<%= headerData._id %>" method="POST" id="headerForm"
                enctype="multipart/form-data">

                <!-- Header Visibility -->
                <div class="row mb-4">
                  <div class="col-md-6">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="headerVisible" name="visible"
                        <%=headerData.visible ? 'checked' : '' %>>
                      <label class="form-check-label fw-bold" for="headerVisible">
                        <i class="fas fa-eye me-1"></i>Header Visible
                      </label>
                    </div>
                  </div>
                </div>
                <div class="col-md-5 mb-2">
                  <label class="form-label fw-bold">Header Name</label>
                  <input type="text" class="form-control" name="name" placeholder="Header Name" value="<%= headerData.name %>">
                </div>
                <!-- Logo Section -->
                <div class="card mb-4">
                  <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-image me-2"></i>Logo Section</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-8">
                        <label class="form-label fw-bold">Logo Upload</label>
                        <div class="logo-preview-container upload-zone" id="logoDropZone">
                          <div id="logoPreview">
                            <% if (headerData.headerlogo && headerData.headerlogo.trim() !=='' ) { %>
                              <div class="logo-wrapper">
                                <img src="/<%= headerData.headerlogo %>" alt="Current Logo" class="logo-preview"
                                  id="currentLogo">
                                <button type="button" class="remove-logo" onclick="removeLogo()" title="Remove Logo">
                                  <i class="fas fa-times"></i>
                                </button>
                              </div>
                              <div class="file-info mt-2">
                                <small class="text-muted">Current logo - Click to change</small>
                              </div>
                              <% } else { %>
                                <div class="logo-placeholder">
                                  <i class="fas fa-image"></i>
                                </div>
                                <div>
                                  <p class="mb-2"><strong>Click to upload or drag and drop</strong></p>
                                  <small class="text-muted">PNG, JPG, GIF up to 2MB</small>
                                </div>
                                <% } %>
                          </div>
                        </div>
                        <input type="file" class="form-control d-none" id="logoInput" name="headerlogo"
                          accept="image/*">
                        <input type="hidden" id="removeLogo" name="removeLogo" value="false">
                        <input type="hidden" id="currentLogo" name="currentLogo" value="<%= headerData.headerlogo %>">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label fw-bold">Logo Settings</label>
                        <div class="mt-3">

                          <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Recommended size: 200x100px or smaller
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Menu Section -->
                <div class="card mb-4">
                  <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                      <h5 class="mb-0"><i class="fas fa-bars me-2"></i>Navigation Menu</h5>
                      <button type="button" class="btn-add" onclick="addMenuItem()">
                        <i class="fas fa-plus me-1"></i>Add Menu Item
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div id="menuContainer">
                      <% if (headerData.menu && headerData.menu.length> 0) { %>
                        <% headerData.menu.forEach((menuItem, menuIndex)=> { %>
                          <div class="dynamic-section">
                            <div class="row">
                              <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Menu Name</label>
                                <input type="text" class="form-control" name="menu[<%= menuIndex %>][name]"
                                  value="<%= menuItem.name || '' %>" placeholder="Home" required>
                              </div>
                              <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Menu Link</label>
                                <input type="text" class="form-control" name="menu[<%= menuIndex %>][link]"
                                  value="<%= menuItem.link || '' %>" placeholder="/" required>
                              </div>
                              <div class="col-md-2 mb-3">
                                <div class="form-check form-switch">
                                  <input class="form-check-input" type="checkbox"
                                    name="menu[<%= menuIndex %>][visible]" <%=menuItem.visible ? 'checked' : ''
                                    %>>
                                  <label class="form-check-label fw-bold">Visible</label>
                                </div>
                              </div>
                              <div class="col-md-2 mb-3">
                                <button type="button" class="btn-remove mt-4" onclick="removeMenuItem(this)">
                                  <i class="fas fa-trash"></i> Remove
                                </button>
                              </div>
                            </div>

                            <!-- Submenu Section -->
                            <div class="mb-3">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Submenu Items</label>
                                <button type="button" class="btn-add btn-sm"
                                  onclick="addSubmenuItem(<%= menuIndex %>, this)">
                                  <i class="fas fa-plus me-1"></i>Add Submenu
                                </button>
                              </div>
                              <div class="submenu-container-<%= menuIndex %>">
                                <% if (menuItem.submenu && menuItem.submenu.length> 0) { %>
                                  <% menuItem.submenu.forEach((submenuItem, submenuIndex)=> { %>
                                    <div class="submenu-section mb-2">
                                      <div class="row">
                                        <div class="col-md-4 mb-2">
                                          <label class="form-label fw-bold">Submenu Name</label>
                                          <input type="text" class="form-control"
                                            name="menu[<%= menuIndex %>][submenu][<%= submenuIndex %>][name]"
                                            value="<%= submenuItem.name || '' %>" placeholder="Submenu Item">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                          <label class="form-label fw-bold">Submenu Link</label>
                                          <input type="text" class="form-control"
                                            name="menu[<%= menuIndex %>][submenu][<%= submenuIndex %>][link]"
                                            value="<%= submenuItem.link || '' %>" placeholder="/submenu">
                                        </div>
                                        <div class="col-md-2 mb-2">
                                          <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                              name="menu[<%= menuIndex %>][submenu][<%= submenuIndex %>][visible]"
                                              <%=submenuItem.visible ? 'checked' : '' %>>
                                            <label class="form-check-label fw-bold">Visible</label>
                                          </div>
                                        </div>
                                        <div class="col-md-2 mb-2">
                                          <button type="button" class="btn-remove btn-sm mt-4"
                                            onclick="removeSubmenuItem(this)">
                                            <i class="fas fa-trash"></i> Remove
                                          </button>
                                        </div>
                                      </div>
                                    </div>
                                    <% }); %>
                                      <% } %>
                              </div>
                            </div>
                          </div>
                          <% }); %>
                            <% } %>
                    </div>
                  </div>
                </div>

                <!-- CTA Section -->
                <div class="card mb-4">
                  <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-mouse-pointer me-2"></i>Call to Action (CTA)</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">CTA Text</label>
                        <input type="text" class="form-control" name="cta[text]"
                          value="<%= headerData.cta && headerData.cta.infoText ? headerData.cta.infoText : '' %>"
                          placeholder="Get Started">
                      </div>
                      <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">CTA Link</label>
                        <input type="text" class="form-control" name="cta[link]"
                          value="<%= headerData.cta && headerData.cta.link ? headerData.cta.link : '' %>"
                          placeholder="/signup">
                      </div>
                      <div class="col-md-4 mb-3">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="ctaVisible" name="cta[visible]"
                            <%=headerData.cta && headerData.cta.visible ? 'checked' : '' %>>
                          <label class="form-check-label fw-bold" for="ctaVisible">CTA Visible</label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Form Actions -->
                <div class="text-center">
                  <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-save me-2"></i>Update Header Configuration
                  </button>
                  <a href="/admin/configurations" class="btn btn-secondary btn-lg px-5 ms-3">
                    <i class="fas fa-times me-2"></i>Cancel
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- contentFor('extra_javascript') %>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        let menuItemIndex = <%= headerData.menu ?headerData.menu.length: 0 %>;
        let submenuIndices = {};

// Initialize submenu indices
<% if (headerData.menu && headerData.menu.length > 0) { %>
  <% headerData.menu.forEach((menuItem, menuIndex) => { %>
          submenuIndices[<%= menuIndex %>] = <%= menuItem.submenu ? menuItem.submenu.length : 0 %>;
  <% }); %>
<% } %>

          // Logo Upload Functionality
          document.addEventListener('DOMContentLoaded', function () {
            const logoDropZone = document.getElementById('logoDropZone');
            const logoInput = document.getElementById('logoInput');
            const logoPreview = document.getElementById('logoPreview');

            // Click to upload
            logoDropZone.addEventListener('click', function () {
              logoInput.click();
            });

            // File input change
            logoInput.addEventListener('change', function (e) {
              handleFileSelect(e.target.files[0]);
            });

            // Drag and drop functionality
            logoDropZone.addEventListener('dragover', function (e) {
              e.preventDefault();
              logoDropZone.classList.add('dragover');
            });

            logoDropZone.addEventListener('dragleave', function (e) {
              e.preventDefault();
              logoDropZone.classList.remove('dragover');
            });

            logoDropZone.addEventListener('drop', function (e) {
              e.preventDefault();
              logoDropZone.classList.remove('dragover');

              const files = e.dataTransfer.files;
              if (files.length > 0 && files[0].type.startsWith('image/')) {
                logoInput.files = files;
                handleFileSelect(files[0]);
              }
            });
          });

        function handleFileSelect(file) {
          if (!file) return;

          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file.');
            return;
          }

          // Validate file size (2MB)
          if (file.size > 2 * 1024 * 1024) {
            alert('File size must be less than 2MB.');
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const logoPreview = document.getElementById('logoPreview');
            logoPreview.innerHTML = `
      <div class="logo-wrapper">
        <img src="${e.target.result}" alt="Logo Preview" class="logo-preview" id="currentLogo">
        <button type="button" class="remove-logo" onclick="removeLogo()" title="Remove Logo">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="file-info mt-2">
        <small class="text-muted">${file.name} (${formatFileSize(file.size)})</small>
      </div>
    `;

            // Reset remove logo flag
            document.getElementById('removeLogo').value = 'false';
          };
          reader.readAsDataURL(file);
        }

        function removeLogo() {
          const logoPreview = document.getElementById('logoPreview');
          const logoInput = document.getElementById('logoInput');

          logoPreview.innerHTML = `
    <div class="logo-placeholder">
      <i class="fas fa-image"></i>
    </div>
    <div>
      <p class="mb-2"><strong>Click to upload or drag and drop</strong></p>
      <small class="text-muted">PNG, JPG, GIF up to 2MB</small>
    </div>
  `;

          logoInput.value = '';
          document.getElementById('removeLogo').value = 'true';
        }

        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Menu Management Functions
        function addMenuItem() {
          const container = document.getElementById('menuContainer');
          const menuDiv = document.createElement('div');
          menuDiv.className = 'dynamic-section';
          submenuIndices[menuItemIndex] = 0;

          menuDiv.innerHTML = `
    <div class="row">
      <div class="col-md-4 mb-3">
        <label class="form-label fw-bold">Menu Name</label>
        <input type="text" class="form-control" name="menu[${menuItemIndex}][name]" placeholder="Home" required>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label fw-bold">Menu Link</label>
        <input type="text" class="form-control" name="menu[${menuItemIndex}][link]" placeholder="/" required>
      </div>
      <div class="col-md-2 mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="menu[${menuItemIndex}][visible]" checked>
          <label class="form-check-label fw-bold">Visible</label>
        </div>
      </div>
      <div class="col-md-2 mb-3">
        <button type="button" class="btn-remove mt-4" onclick="removeMenuItem(this)">
          <i class="fas fa-trash"></i> Remove
        </button>
      </div>
    </div>
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <label class="form-label fw-bold mb-0">Submenu Items</label>
        <button type="button" class="btn-add btn-sm" onclick="addSubmenuItem(${menuItemIndex}, this)">
          <i class="fas fa-plus me-1"></i>Add Submenu
        </button>
      </div>
      <div class="submenu-container-${menuItemIndex}"></div>
    </div>
  `;
          container.appendChild(menuDiv);
          menuItemIndex++;
        }

        function removeMenuItem(button) {
          if (confirm('Are you sure you want to remove this menu item?')) {
            button.closest('.dynamic-section').remove();
          }
        }

        function addSubmenuItem(menuIndex, button) {
          const submenuContainer = document.querySelector(`.submenu-container-${menuIndex}`);
          if (!submenuIndices[menuIndex]) submenuIndices[menuIndex] = 0;

          const submenuDiv = document.createElement('div');
          submenuDiv.className = 'submenu-section mb-2';
          submenuDiv.innerHTML = `
    <div class="row">
      <div class="col-md-4 mb-2">
        <label class="form-label fw-bold">Submenu Name</label>
        <input type="text" class="form-control" name="menu[${menuIndex}][submenu][${submenuIndices[menuIndex]}][name]" placeholder="Submenu Item">
      </div>
      <div class="col-md-4 mb-2">
        <label class="form-label fw-bold">Submenu Link</label>
        <input type="text" class="form-control" name="menu[${menuIndex}][submenu][${submenuIndices[menuIndex]}][link]" placeholder="/submenu">
      </div>
      <div class="col-md-2 mb-2">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="menu[${menuIndex}][submenu][${submenuIndices[menuIndex]}][visible]" checked>
          <label class="form-check-label fw-bold">Visible</label>
        </div>
      </div>
      <div class="col-md-2 mb-2">
        <button type="button" class="btn-remove btn-sm mt-4" onclick="removeSubmenuItem(this)">
          <i class="fas fa-trash"></i> Remove
        </button>
      </div>
    </div>
  `;

          submenuContainer.appendChild(submenuDiv);
          submenuIndices[menuIndex]++;
        }

        function removeSubmenuItem(button) {
          if (confirm('Are you sure you want to remove this submenu item?')) {
            button.closest('.submenu-section').remove();
          }
        }

        // Form validation
        document.getElementById('headerForm').addEventListener('submit', function (e) {
          const menuItems = document.querySelectorAll('input[name*="[menu]"][name*="[name]"]');
          let hasValidMenu = false;

          menuItems.forEach(item => {
            if (item.value.trim() !== '') {
              hasValidMenu = true;
            }
          });

          if (!hasValidMenu && menuItems.length > 0) {
            e.preventDefault();
            alert('Please provide at least one menu item name or remove all menu items.');
            return false;
          }
        });
      </script>